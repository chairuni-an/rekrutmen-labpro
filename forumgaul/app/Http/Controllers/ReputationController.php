<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;

use App\Http\Requests;
use DB;
use Auth;
use App\Post;
use App\Thread;
use App\Reputation;
use App\Http\Requests\ReputationRequest;

class ReputationController extends Controller
{
	public function initform($post_id) {
		$post = Post::find($post_id);
		$posting_user = $post->user_id;
		return view('add_reputation', ['post_id' => $post_id, 'posting_user' => $posting_user]);
	}

    public function add(ReputationRequest $request) {
    	$rep = new Reputation;
    	$rep->post_id = $request->post_id;
    	$rep->giver_id = Auth::user()->id;

    	$val = $request->input('value');
    	if($val == 'good') {
    		$val = 1;
    	}
    	else {
    		$val = -1;
    	}

        $rep->value = $val;
    	$rep->message = $request->input('message');
    	$rep->save();
    	return view('reputation_given');
    }

    public function index() {
        /*
        $my_posts = Post::where('user_id', '=', Auth::user()->id)->get();
        $my_reps = Reputation::all();
        */
        $my_reps = DB::table('reps')
                   ->join('posts', 'posts.id', '=', 'reps.post_id')
                   ->join('users', 'reps.giver_id', '=', 'users.id')
                   ->where('posts.user_id','=', Auth::user()->id)
                   ->select('reps.*', 'users.name AS giver_name', 'posts.title AS post_title')
                   ->get();
        /*
        $my_reps = $my_posts->first()->reputation;
        foreach($my_posts as $post) {
            $this_post_rep = $post->reputation;
            $my_reps = $my_reps->merge($this_post_rep);
        }
        */
        return view('my_reputation', ['rep' => $my_reps]);
    }
}
